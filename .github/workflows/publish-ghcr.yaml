name: Build and Publish Image

on:
  pull_request:
    types:
      - closed

jobs:
  extract-version:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Extract Version
        id: version
        run: |
          # Use maven to get application version
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo 'Extracted Version: $VERSION'
          
          # Check version is not empty
          if [ -z "$VERSION" ]; then
            echo "Error: Version could not be extracted from pom.xml"
            exit 1
          fi
          
          # Set the output variable
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

  build-and-publish:
    runs-on: ubuntu-latest
    needs: extract-version
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    env:
      VERSION: ${{ needs.extract-version.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Github Container Registry
        run: |
          docker login --username dj45x --password ${{ secrets.ELDRITCH_PAT }} ghcr.io
          echo "Login successful"

      - name: Build and Publish Image
        env:
          VERSION: ${{ needs.extract-version.outputs.version }}
        run: |
          VERSION=${{ env.VERSION }}
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          TAG="ghcr.io/dj45x/eldritch-observer:${VERSION}"
          echo "Eldritch Version: $VERSION | Base Branch: $BASE_BRANCH"
          
          # Build the docker image
          docker build . -t ghcr.io/dj45x/eldritch-observer:${TAG}
          
          # Push the image to ghcr
          docker push ghcr.io/dj45x/eldritch-observer:${TAG}
          
          # Tag Image as Latest
          if [ "$BASE_BRANCH" == "main" ]; then
            docker tag ghcr.io/dj45x/eldritch-observer:${TAG} ghcr.io/dj45x/eldritch-observer:latest
            docker push ghcr.io/dj45x/eldritch-observer:latest
          fi